#!/usr/bin/with-contenv bashio
# ==============================================================================
# Actual Budget Complete Add-on - Native HA Integration
# Creates dashboard tiles and entities for Home Assistant
# ==============================================================================

# Wait for Home Assistant API to be available
bashio::log.info "ðŸ  Starting Actual Budget native Home Assistant integration..."
bashio::log.info "â³ Waiting for Home Assistant API..."

# Wait for supervisor token
while [[ -z "${SUPERVISOR_TOKEN}" ]]; do
    sleep 1
done

bashio::log.info "âœ… Home Assistant API ready"

# Parse configuration
EXTERNAL_API_URL=$(bashio::config 'external_api_url')
EXTERNAL_ACTUAL_URL=$(bashio::config 'external_actual_url')
API_SERVER_PORT=$(bashio::config 'api_server_port')
ACTUAL_SERVER_PORT=$(bashio::config 'actual_server_port')
LOG_LEVEL=$(bashio::config 'log_level')

# Set log level
bashio::log.level "${LOG_LEVEL}"

bashio::log.info "ðŸ“Š Creating native Home Assistant dashboard entities..."

# Function to create entity
create_entity() {
    local entity_id="$1"
    local name="$2"
    local icon="$3"
    local initial_state="$4"
    local attributes="$5"
    
    local payload="{
        \"state\": \"${initial_state}\",
        \"attributes\": {
            \"friendly_name\": \"${name}\",
            \"icon\": \"${icon}\",
            ${attributes}
        }
    }"
    
    curl -s -X POST \
        -H "Authorization: Bearer ${SUPERVISOR_TOKEN}" \
        -H "Content-Type: application/json" \
        -d "${payload}" \
        "http://supervisor/core/api/states/${entity_id}" > /dev/null 2>&1
    
    if [[ $? -eq 0 ]]; then
        bashio::log.debug "âœ… Created entity: ${entity_id}"
    else
        bashio::log.warning "âš ï¸ Failed to create entity: ${entity_id}"
    fi
}

# Create dashboard entities
bashio::log.info "ðŸŽ¯ Creating status tiles..."

create_entity "sensor.actual_budget_system_status" \
    "System Status" \
    "mdi:calculator-variant" \
    "running" \
    '"description": "Overall system health", "tooltip": "Green=Running, Yellow=Issues, Red=Failed", "version": "2.0.1"'

create_entity "sensor.actual_budget_api_status" \
    "API Server" \
    "mdi:api" \
    "checking" \
    '"description": "Node.js API server status", "tooltip": "Connect to your existing API server", "external_url": "'${EXTERNAL_API_URL}'"'

create_entity "sensor.actual_budget_server_status" \
    "Actual Budget Server" \
    "mdi:server" \
    "checking" \
    '"description": "Official Actual Budget server", "tooltip": "Connect to your existing server", "external_url": "'${EXTERNAL_ACTUAL_URL}'"'

create_entity "sensor.actual_budget_last_sync" \
    "Last Sync" \
    "mdi:sync" \
    "never" \
    '"description": "Last synchronization time", "tooltip": "When transactions were last synced to Xero"'

bashio::log.info "ðŸ“ˆ Creating statistics tiles..."

create_entity "sensor.actual_budget_transactions_processed" \
    "Transactions Processed" \
    "mdi:counter" \
    "0" \
    '"unit_of_measurement": "transactions", "description": "Total processed", "tooltip": "ðŸ”¸ PLACEHOLDER: Shows test data until connected to API server"'

create_entity "sensor.actual_budget_successful_imports" \
    "Successful Imports" \
    "mdi:check-circle" \
    "0" \
    '"unit_of_measurement": "transactions", "description": "Successfully imported to Xero", "tooltip": "ðŸ”¸ PLACEHOLDER: Shows test data until connected to API server"'

create_entity "sensor.actual_budget_failed_transactions" \
    "Failed Transactions" \
    "mdi:alert-circle" \
    "0" \
    '"unit_of_measurement": "transactions", "description": "Failed imports", "tooltip": "ðŸ”¸ PLACEHOLDER: Shows test data until connected to API server"'

create_entity "sensor.actual_budget_pending_mappings" \
    "Pending Mappings" \
    "mdi:map-marker-question" \
    "0" \
    '"unit_of_measurement": "mappings", "description": "Awaiting category mapping", "tooltip": "ðŸ”¸ PLACEHOLDER: Shows test data until connected to API server"'

bashio::log.info "ðŸŽ‰ Native HA dashboard integration complete!"
bashio::log.info "ðŸ“± Look for 'Actual Budget' in your Home Assistant sidebar"
bashio::log.info "ðŸ“Š Dashboard tiles created with placeholder data"

# Show configuration info
if [[ -n "${EXTERNAL_API_URL}" ]]; then
    bashio::log.info "ðŸ”— API Server URL: ${EXTERNAL_API_URL}"
else
    bashio::log.info "âš ï¸ No API server URL configured - configure external_api_url"
fi

if [[ -n "${EXTERNAL_ACTUAL_URL}" ]]; then
    bashio::log.info "ðŸ”— Actual Budget URL: ${EXTERNAL_ACTUAL_URL}"
else
    bashio::log.info "âš ï¸ No Actual Budget URL configured - configure external_actual_url"
fi

# Function to check service health
check_service_health() {
    local service_name="$1"
    local url="$2"
    
    if [[ -z "${url}" ]]; then
        return 1
    fi
    
    # Try to connect to the service
    if curl -s -f "${url}/health" > /dev/null 2>&1 || curl -s -f "${url}" > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# Main service loop - keep the add-on running and update entities periodically
bashio::log.info "ðŸ”„ Starting monitoring loop..."

while true; do
    # Check API server health
    if [[ -n "${EXTERNAL_API_URL}" ]]; then
        if check_service_health "API Server" "${EXTERNAL_API_URL}"; then
            curl -s -X POST \
                -H "Authorization: Bearer ${SUPERVISOR_TOKEN}" \
                -H "Content-Type: application/json" \
                -d '{"state": "online", "attributes": {"friendly_name": "API Server", "icon": "mdi:api", "description": "Connected and responding", "last_check": "'$(date -Iseconds)'"}}' \
                "http://supervisor/core/api/states/sensor.actual_budget_api_status" > /dev/null 2>&1
        else
            curl -s -X POST \
                -H "Authorization: Bearer ${SUPERVISOR_TOKEN}" \
                -H "Content-Type: application/json" \
                -d '{"state": "offline", "attributes": {"friendly_name": "API Server", "icon": "mdi:api-off", "description": "Cannot connect to API server", "last_check": "'$(date -Iseconds)'"}}' \
                "http://supervisor/core/api/states/sensor.actual_budget_api_status" > /dev/null 2>&1
        fi
    fi
    
    # Check Actual Budget server health
    if [[ -n "${EXTERNAL_ACTUAL_URL}" ]]; then
        if check_service_health "Actual Budget Server" "${EXTERNAL_ACTUAL_URL}"; then
            curl -s -X POST \
                -H "Authorization: Bearer ${SUPERVISOR_TOKEN}" \
                -H "Content-Type: application/json" \
                -d '{"state": "online", "attributes": {"friendly_name": "Actual Budget Server", "icon": "mdi:server", "description": "Connected and responding", "last_check": "'$(date -Iseconds)'"}}' \
                "http://supervisor/core/api/states/sensor.actual_budget_server_status" > /dev/null 2>&1
        else
            curl -s -X POST \
                -H "Authorization: Bearer ${SUPERVISOR_TOKEN}" \
                -H "Content-Type: application/json" \
                -d '{"state": "offline", "attributes": {"friendly_name": "Actual Budget Server", "icon": "mdi:server-off", "description": "Cannot connect to Actual Budget server", "last_check": "'$(date -Iseconds)'"}}' \
                "http://supervisor/core/api/states/sensor.actual_budget_server_status" > /dev/null 2>&1
        fi
    fi
    
    # Update system status with current timestamp
    curl -s -X POST \
        -H "Authorization: Bearer ${SUPERVISOR_TOKEN}" \
        -H "Content-Type: application/json" \
        -d "{
            \"state\": \"running\",
            \"attributes\": {
                \"friendly_name\": \"System Status\",
                \"icon\": \"mdi:calculator-variant\",
                \"description\": \"Native HA integration active\",
                \"last_update\": \"$(date -Iseconds)\",
                \"version\": \"2.0.1\",
                \"integration_type\": \"native_dashboard\"
            }
        }" \
        "http://supervisor/core/api/states/sensor.actual_budget_system_status" > /dev/null 2>&1
    
    # Sleep for 2 minutes before next health check
    sleep 120
done