#!/usr/bin/with-contenv bashio
# ==============================================================================
# Actual Budget Complete Add-on - Native HA Integration
# Creates dashboard tiles and entities for Home Assistant
# ==============================================================================

# Enable error handling and verbose logging
set +e
set -x

# Log script start
bashio::log.info "üöÄ Script starting with PID: $$"

# Wait for Home Assistant API to be available
bashio::log.info "üè† Starting Actual Budget native Home Assistant integration..."
bashio::log.info "‚è≥ Waiting for Home Assistant API..."

# Wait for supervisor token with timeout
timeout=60
counter=0
while [[ -z "${SUPERVISOR_TOKEN}" && $counter -lt $timeout ]]; do
    sleep 1
    ((counter++))
done

if [[ -z "${SUPERVISOR_TOKEN}" ]]; then
    bashio::log.error "‚ùå Failed to get supervisor token after ${timeout} seconds"
    exit 1
fi

bashio::log.info "‚úÖ Home Assistant API ready"

# Parse configuration with defaults
EXTERNAL_API_URL=$(bashio::config 'external_api_url' '')
EXTERNAL_ACTUAL_URL=$(bashio::config 'external_actual_url' '')
API_SERVER_PORT=$(bashio::config 'api_server_port' '3001')
ACTUAL_SERVER_PORT=$(bashio::config 'actual_server_port' '5006')
LOG_LEVEL=$(bashio::config 'log_level' 'info')

# HP Automation Configuration
HP_AUTOMATION_ENABLED=$(bashio::config 'hp_automation_enabled' 'true')
HP_CATEGORY_GROUP_ID=$(bashio::config 'hp_category_group_id' 'a85d9076-d269-4eb4-ab58-92d2f37997c6')
HP_DRY_RUN_MODE=$(bashio::config 'hp_dry_run_mode' 'false')
HP_MAX_BATCH_SIZE=$(bashio::config 'hp_max_transactions_per_batch' '50')
ACTUAL_BUDGET_PASSWORD=$(bashio::config 'actual_budget_password' '')

# Set log level
bashio::log.level "${LOG_LEVEL}"

bashio::log.info "üìä Creating native Home Assistant dashboard entities..."

# Function to create entity with error handling
create_entity() {
    local entity_id="$1"
    local name="$2"
    local icon="$3"
    local initial_state="$4"
    local attributes="$5"
    
    local payload="{
        \"state\": \"${initial_state}\",
        \"attributes\": {
            \"friendly_name\": \"${name}\",
            \"icon\": \"${icon}\",
            ${attributes}
        }
    }"
    
    local response
    response=$(curl -s -w "%{http_code}" -X POST \
        -H "Authorization: Bearer ${SUPERVISOR_TOKEN}" \
        -H "Content-Type: application/json" \
        -d "${payload}" \
        "http://supervisor/core/api/states/${entity_id}" 2>/dev/null)
    
    local http_code="${response: -3}"
    if [[ "$http_code" =~ ^2[0-9][0-9]$ ]]; then
        bashio::log.debug "‚úÖ Created entity: ${entity_id}"
        return 0
    else
        bashio::log.warning "‚ö†Ô∏è Failed to create entity: ${entity_id} (HTTP: ${http_code})"
        return 1
    fi
}

# Create dashboard entities
bashio::log.info "üéØ Creating status tiles..."

create_entity "sensor.actual_budget_system_status" \
    "System Status" \
    "mdi:calculator-variant" \
    "running" \
    '"description": "Overall system health", "tooltip": "Green=Running, Yellow=Issues, Red=Failed", "version": "2.0.1"'

create_entity "sensor.actual_budget_api_status" \
    "API Server" \
    "mdi:api" \
    "checking" \
    '"description": "Node.js API server status", "tooltip": "Connect to your existing API server", "external_url": "'${EXTERNAL_API_URL}'"'

create_entity "sensor.actual_budget_server_status" \
    "Actual Budget Server" \
    "mdi:server" \
    "checking" \
    '"description": "Official Actual Budget server", "tooltip": "Connect to your existing server", "external_url": "'${EXTERNAL_ACTUAL_URL}'"'

create_entity "sensor.actual_budget_last_sync" \
    "Last Sync" \
    "mdi:sync" \
    "never" \
    '"description": "Last synchronization time", "tooltip": "When transactions were last synced to Xero"'

bashio::log.info "üìà Creating statistics tiles..."

create_entity "sensor.actual_budget_transactions_processed" \
    "Transactions Processed" \
    "mdi:counter" \
    "0" \
    '"unit_of_measurement": "transactions", "description": "Total processed", "tooltip": "üî∏ PLACEHOLDER: Shows test data until connected to API server"'

create_entity "sensor.actual_budget_successful_imports" \
    "Successful Imports" \
    "mdi:check-circle" \
    "0" \
    '"unit_of_measurement": "transactions", "description": "Successfully imported to Xero", "tooltip": "üî∏ PLACEHOLDER: Shows test data until connected to API server"'

create_entity "sensor.actual_budget_failed_transactions" \
    "Failed Transactions" \
    "mdi:alert-circle" \
    "0" \
    '"unit_of_measurement": "transactions", "description": "Failed imports", "tooltip": "üî∏ PLACEHOLDER: Shows test data until connected to API server"'

create_entity "sensor.actual_budget_pending_mappings" \
    "Pending Mappings" \
    "mdi:map-marker-question" \
    "0" \
    '"unit_of_measurement": "mappings", "description": "Awaiting category mapping", "tooltip": "üî∏ PLACEHOLDER: Shows test data until connected to API server"'

bashio::log.info "üè• Creating HP transaction automation entities..."

create_entity "sensor.actual_budget_hp_automation_status" \
    "HP Automation Status" \
    "mdi:medical-bag" \
    "${HP_AUTOMATION_ENABLED}" \
    '"description": "HP transaction automation status", "tooltip": "Shows if HP automation is enabled", "category_group_id": "'${HP_CATEGORY_GROUP_ID}'"'

create_entity "sensor.actual_budget_hp_pending_transactions" \
    "HP Pending Transactions" \
    "mdi:clipboard-list" \
    "0" \
    '"unit_of_measurement": "transactions", "description": "HP transactions awaiting processing", "tooltip": "Reconciled HP transactions without #HP- tags"'

create_entity "sensor.actual_budget_hp_submitted_transactions" \
    "HP Submitted Transactions" \
    "mdi:upload" \
    "0" \
    '"unit_of_measurement": "transactions", "description": "HP transactions submitted to Xano", "tooltip": "Transactions with #HP-Submitted tag"'

create_entity "sensor.actual_budget_hp_paid_transactions" \
    "HP Paid Transactions" \
    "mdi:check-circle" \
    "0" \
    '"unit_of_measurement": "transactions", "description": "HP transactions marked as paid", "tooltip": "Transactions with #HP-Paid tag"'

create_entity "sensor.actual_budget_hp_failed_transactions" \
    "HP Failed Transactions" \
    "mdi:alert-circle" \
    "0" \
    '"unit_of_measurement": "transactions", "description": "HP transactions with processing errors", "tooltip": "Failed HP transactions needing attention"'

create_entity "sensor.actual_budget_hp_last_processing" \
    "HP Last Processing" \
    "mdi:clock-outline" \
    "never" \
    '"description": "Last HP transaction processing run", "tooltip": "When HP transactions were last processed"'

bashio::log.info "üéâ Native HA dashboard integration complete!"
bashio::log.info "üì± Look for 'Actual Budget' in your Home Assistant sidebar"
bashio::log.info "üìä Dashboard tiles created with placeholder data"

# Start web server for ingress panel
bashio::log.info "üåê Starting web server for dashboard panel..."
cd /opt/dashboard
node server.js &
WEB_SERVER_PID=$!
bashio::log.info "‚úÖ Web server started on port 8099 (PID: ${WEB_SERVER_PID})"

# Show configuration info
if [[ -n "${EXTERNAL_API_URL}" ]]; then
    bashio::log.info "üîó API Server URL: ${EXTERNAL_API_URL}"
else
    bashio::log.info "‚ö†Ô∏è No API server URL configured - configure external_api_url"
fi

if [[ -n "${EXTERNAL_ACTUAL_URL}" ]]; then
    bashio::log.info "üîó Actual Budget URL: ${EXTERNAL_ACTUAL_URL}"
else
    bashio::log.info "‚ö†Ô∏è No Actual Budget URL configured - configure external_actual_url"
fi

# Function to update entity state with error handling
update_entity_state() {
    local entity_id="$1"
    local state="$2"
    local attributes="$3"
    
    local payload="{\"state\": \"${state}\", \"attributes\": ${attributes}}"
    
    curl -s -X POST \
        -H "Authorization: Bearer ${SUPERVISOR_TOKEN}" \
        -H "Content-Type: application/json" \
        -d "${payload}" \
        "http://supervisor/core/api/states/${entity_id}" > /dev/null 2>&1
}

# Function to check service health with timeout
check_service_health() {
    local service_name="$1"
    local url="$2"
    
    if [[ -z "${url}" ]]; then
        return 1
    fi
    
    # Try to connect to the service with timeout
    if timeout 10 curl -s -f "${url}/health" > /dev/null 2>&1 || timeout 10 curl -s -f "${url}" > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# Function to detect HP transactions from Actual Budget
detect_hp_transactions() {
    local actual_url="$1"
    local password="$2"
    local category_group_id="$3"
    
    if [[ -z "${actual_url}" || -z "${password}" ]]; then
        bashio::log.debug "‚ùå HP Detection: Missing Actual Budget URL or password"
        return 1
    fi
    
    bashio::log.debug "üîç HP Detection: Scanning for HP transactions in category group ${category_group_id}"
    
    # This is a placeholder for the actual API call to Actual Budget
    # In a real implementation, this would:
    # 1. Connect to Actual Budget API
    # 2. Get transactions for the HP category group
    # 3. Filter for reconciled transactions only
    # 4. Check notes for existing #HP- tags
    # 5. Return eligible transactions
    
    # For now, return mock data to test the infrastructure
    echo "[]"  # Empty array - no transactions found
}

# Function to process HP transactions
process_hp_transactions() {
    local transactions="$1"
    local dry_run="$2"
    
    if [[ "${dry_run}" == "true" ]]; then
        bashio::log.info "üß™ HP Processing: DRY RUN MODE - No actual processing"
        return 0
    fi
    
    # Count transactions to process
    local transaction_count
    transaction_count=$(echo "${transactions}" | jq '. | length' 2>/dev/null || echo "0")
    
    if [[ "${transaction_count}" -eq 0 ]]; then
        bashio::log.debug "‚úÖ HP Processing: No eligible transactions found"
        return 0
    fi
    
    bashio::log.info "üè• HP Processing: Found ${transaction_count} eligible HP transactions"
    
    # This is a placeholder for the actual processing logic
    # In a real implementation, this would:
    # 1. Submit transactions to Xano
    # 2. Update transaction notes with #HP-Submitted
    # 3. Handle errors and retries
    # 4. Update statistics
    
    return 0
}

# Function to update HP statistics
update_hp_statistics() {
    local pending_count="$1"
    local submitted_count="$2"
    local paid_count="$3"
    local failed_count="$4"
    local last_processing="$5"
    
    # Update HP automation status
    update_entity_state "sensor.actual_budget_hp_automation_status" "${HP_AUTOMATION_ENABLED}" \
        '{"friendly_name": "HP Automation Status", "icon": "mdi:medical-bag", "description": "HP automation is '${HP_AUTOMATION_ENABLED}'", "category_group_id": "'${HP_CATEGORY_GROUP_ID}'", "last_check": "'$(date -Iseconds)'"}'
    
    # Update transaction counts
    update_entity_state "sensor.actual_budget_hp_pending_transactions" "${pending_count}" \
        '{"friendly_name": "HP Pending Transactions", "icon": "mdi:clipboard-list", "description": "Transactions awaiting processing", "unit_of_measurement": "transactions"}'
    
    update_entity_state "sensor.actual_budget_hp_submitted_transactions" "${submitted_count}" \
        '{"friendly_name": "HP Submitted Transactions", "icon": "mdi:upload", "description": "Transactions submitted to Xano", "unit_of_measurement": "transactions"}'
    
    update_entity_state "sensor.actual_budget_hp_paid_transactions" "${paid_count}" \
        '{"friendly_name": "HP Paid Transactions", "icon": "mdi:check-circle", "description": "Transactions marked as paid", "unit_of_measurement": "transactions"}'
    
    update_entity_state "sensor.actual_budget_hp_failed_transactions" "${failed_count}" \
        '{"friendly_name": "HP Failed Transactions", "icon": "mdi:alert-circle", "description": "Transactions with errors", "unit_of_measurement": "transactions"}'
    
    update_entity_state "sensor.actual_budget_hp_last_processing" "${last_processing}" \
        '{"friendly_name": "HP Last Processing", "icon": "mdi:clock-outline", "description": "Last processing run", "last_update": "'$(date -Iseconds)'"}'
}

# Cleanup function for graceful shutdown
cleanup() {
    bashio::log.info "üõë Received shutdown signal, cleaning up..."
    if [[ -n "${WEB_SERVER_PID}" ]]; then
        kill ${WEB_SERVER_PID} 2>/dev/null || true
        bashio::log.info "üåê Web server stopped"
    fi
    exit 0
}

# Set up signal handlers
trap cleanup SIGTERM SIGINT

# Main service loop - keep the add-on running and update entities periodically
bashio::log.info "üîÑ Starting monitoring loop..."
bashio::log.info "üí° Add-on will run continuously and update dashboard every 2 minutes"

# Initialize loop counter
loop_count=0

# Infinite loop to keep the service running
while true; do
    ((loop_count++))
    bashio::log.debug "üîÑ Health check cycle ${loop_count}"
    
    # Check API server health
    if [[ -n "${EXTERNAL_API_URL}" ]]; then
        if check_service_health "API Server" "${EXTERNAL_API_URL}"; then
            update_entity_state "sensor.actual_budget_api_status" "online" \
                '{"friendly_name": "API Server", "icon": "mdi:api", "description": "Connected and responding", "last_check": "'$(date -Iseconds)'"}'
            bashio::log.debug "‚úÖ API Server: online"
        else
            update_entity_state "sensor.actual_budget_api_status" "offline" \
                '{"friendly_name": "API Server", "icon": "mdi:api-off", "description": "Cannot connect to API server", "last_check": "'$(date -Iseconds)'"}'
            bashio::log.debug "‚ùå API Server: offline"
        fi
    else
        update_entity_state "sensor.actual_budget_api_status" "not_configured" \
            '{"friendly_name": "API Server", "icon": "mdi:api-off", "description": "No external API URL configured", "last_check": "'$(date -Iseconds)'"}'
    fi
    
    # Check Actual Budget server health
    if [[ -n "${EXTERNAL_ACTUAL_URL}" ]]; then
        if check_service_health "Actual Budget Server" "${EXTERNAL_ACTUAL_URL}"; then
            update_entity_state "sensor.actual_budget_server_status" "online" \
                '{"friendly_name": "Actual Budget Server", "icon": "mdi:server", "description": "Connected and responding", "last_check": "'$(date -Iseconds)'"}'
            bashio::log.debug "‚úÖ Actual Budget Server: online"
        else
            update_entity_state "sensor.actual_budget_server_status" "offline" \
                '{"friendly_name": "Actual Budget Server", "icon": "mdi:server-off", "description": "Cannot connect to Actual Budget server", "last_check": "'$(date -Iseconds)'"}'
            bashio::log.debug "‚ùå Actual Budget Server: offline"
        fi
    else
        update_entity_state "sensor.actual_budget_server_status" "not_configured" \
            '{"friendly_name": "Actual Budget Server", "icon": "mdi:server-off", "description": "No external Actual Budget URL configured", "last_check": "'$(date -Iseconds)'"}'
    fi
    
    # Update system status with current timestamp
    update_entity_state "sensor.actual_budget_system_status" "running" \
        '{"friendly_name": "System Status", "icon": "mdi:calculator-variant", "description": "Native HA integration active", "last_update": "'$(date -Iseconds)'", "version": "2.0.2", "integration_type": "native_dashboard", "loop_count": '${loop_count}'}'
    
    # HP Transaction Processing (if enabled)
    if [[ "${HP_AUTOMATION_ENABLED}" == "true" ]]; then
        bashio::log.debug "üè• HP Processing: Starting HP transaction detection"
        
        # Detect HP transactions
        hp_transactions=$(detect_hp_transactions "${EXTERNAL_ACTUAL_URL}" "${ACTUAL_BUDGET_PASSWORD}" "${HP_CATEGORY_GROUP_ID}")
        
        # Process transactions if any found
        if [[ -n "${hp_transactions}" ]]; then
            process_hp_transactions "${hp_transactions}" "${HP_DRY_RUN_MODE}"
        fi
        
        # Update HP statistics (placeholder values for now)
        update_hp_statistics "0" "0" "0" "0" "$(date -Iseconds)"
        
        bashio::log.debug "‚úÖ HP Processing: Completed HP transaction cycle"
    else
        bashio::log.debug "‚è∏Ô∏è HP Processing: HP automation disabled"
        update_entity_state "sensor.actual_budget_hp_automation_status" "disabled" \
            '{"friendly_name": "HP Automation Status", "icon": "mdi:medical-bag-off", "description": "HP automation is disabled", "last_check": "'$(date -Iseconds)'"}'
    fi
    
    # Log status every 10 cycles (20 minutes)
    if (( loop_count % 10 == 0 )); then
        bashio::log.info "üíì Add-on running healthy - completed ${loop_count} health check cycles"
    fi
    
    # Sleep for 2 minutes before next health check
    # Use sleep with explicit duration to ensure proper blocking
    sleep 120 || true
done

# This line should never be reached
bashio::log.error "‚ùå Monitoring loop exited unexpectedly!"
exit 1